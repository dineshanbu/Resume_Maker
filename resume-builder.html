<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Builder - ResumePro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
    <!-- Builder Header -->
    <div class="bg-white border-bottom sticky-top">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center py-3">
                <div>
                    <a href="dashboard.html" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back
                    </a>
                </div>
                <h5 class="mb-0 fw-bold">Resume Builder</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="saveBtn">
                        <i class="bi bi-save me-2"></i>Save
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="previewResume()">
                        <i class="bi bi-eye me-2"></i>Preview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="builder-container">
        <!-- Builder Form -->
        <div class="builder-form">
            <form id="resumeForm">
                <!-- Template Selection -->
                <div class="form-section">
                    <h4><i class="bi bi-palette me-2"></i>Choose Template</h4>
                    <select class="form-select" id="template" required>
                        <option value="Professional">Professional</option>
                        <option value="Modern">Modern</option>
                        <option value="Creative">Creative</option>
                        <option value="Executive">Executive</option>
                        <option value="Minimal">Minimal</option>
                    </select>
                </div>

                <!-- Resume Name -->
                <div class="form-section">
                    <h4><i class="bi bi-file-earmark-text me-2"></i>Resume Name</h4>
                    <input type="text" class="form-control" id="resumeName" placeholder="e.g., Software Engineer Resume" required>
                </div>

                <!-- Personal Information -->
                <div class="form-section">
                    <h4><i class="bi bi-person me-2"></i>Personal Information</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" placeholder="John Doe" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="john@example.com" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" placeholder="+1 234 567 8900" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" placeholder="New York, NY">
                        </div>
                        <div class="col-12">
                            <label class="form-label">LinkedIn (Optional)</label>
                            <input type="url" class="form-control" id="linkedin" placeholder="https://linkedin.com/in/johndoe">
                        </div>
                    </div>
                </div>

                <!-- Professional Summary -->
                <div class="form-section">
                    <h4><i class="bi bi-text-paragraph me-2"></i>Professional Summary</h4>
                    <textarea class="form-control" id="summary" rows="4" placeholder="Write a brief summary of your professional background and key achievements..."></textarea>
                    <small class="text-muted">Tip: Keep it concise (3-4 sentences) and highlight your unique value proposition.</small>
                </div>

                <!-- Work Experience -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="bi bi-briefcase me-2"></i>Work Experience</h4>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addExperience()">
                            <i class="bi bi-plus-circle me-1"></i>Add Experience
                        </button>
                    </div>
                    <div id="experienceContainer" class="dynamic-fields-container">
                        <!-- Experience items will be added here -->
                    </div>
                </div>

                <!-- Education -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="bi bi-mortarboard me-2"></i>Education</h4>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addEducation()">
                            <i class="bi bi-plus-circle me-1"></i>Add Education
                        </button>
                    </div>
                    <div id="educationContainer" class="dynamic-fields-container">
                        <!-- Education items will be added here -->
                    </div>
                </div>

                <!-- Skills -->
                <div class="form-section">
                    <h4><i class="bi bi-gear me-2"></i>Skills</h4>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="skillInput" placeholder="Type a skill and press Enter">
                        <small class="text-muted">Add relevant skills one by one. Press Enter after each skill.</small>
                    </div>
                    <div id="skillsContainer" class="tags-container">
                        <!-- Skills will be displayed here as tags -->
                    </div>
                </div>

                <!-- Projects (Optional) -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="bi bi-code-square me-2"></i>Projects (Optional)</h4>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addProject()">
                            <i class="bi bi-plus-circle me-1"></i>Add Project
                        </button>
                    </div>
                    <div id="projectsContainer" class="dynamic-fields-container">
                        <!-- Project items will be added here -->
                    </div>
                </div>

                <!-- Certifications (Optional) -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0"><i class="bi bi-award me-2"></i>Certifications (Optional)</h4>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addCertification()">
                            <i class="bi bi-plus-circle me-1"></i>Add Certification
                        </button>
                    </div>
                    <div id="certificationsContainer" class="dynamic-fields-container">
                        <!-- Certification items will be added here -->
                    </div>
                </div>
            </form>
        </div>

        <!-- Live Preview -->
        <div class="builder-preview">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0">Live Preview</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="zoomOut()">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="zoomIn()">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                </div>
            </div>
            
            <div id="resumePreview" class="border rounded p-4 bg-white" style="transform-origin: top center;">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
                    <p class="mt-3">Start filling the form to see live preview</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/auth.js"></script>
    <script src="./assets/js/resume.js"></script>
    <script>
        if (!requireAuth()) throw new Error('Unauthorized');

        let currentResumeId = null;
        let skills = [];
        let experiences = [];
        let educations = [];
        let projects = [];
        let certifications = [];
        let zoomLevel = 1;

        // Check if editing existing resume
        const urlParams = new URLSearchParams(window.location.search);
        const editingResumeId = urlParams.get('id');

        if (editingResumeId) {
            loadExistingResume(editingResumeId);
        } else {
            // Add one default experience and education
            addExperience();
            addEducation();
        }

        function loadExistingResume(id) {
            const resume = getResumeById(id);
            if (resume) {
                currentResumeId = id;
                document.getElementById('resumeName').value = resume.name;
                document.getElementById('template').value = resume.template;
                
                const data = resume.data || {};
                if (data.fullName) document.getElementById('fullName').value = data.fullName;
                if (data.email) document.getElementById('email').value = data.email;
                if (data.phone) document.getElementById('phone').value = data.phone;
                if (data.location) document.getElementById('location').value = data.location;
                if (data.linkedin) document.getElementById('linkedin').value = data.linkedin;
                if (data.summary) document.getElementById('summary').value = data.summary;
                
                // Load skills
                if (data.skills) {
                    skills = data.skills;
                    updateSkillsDisplay();
                }
                
                // Load experiences
                if (data.experience && data.experience.length > 0) {
                    data.experience.forEach(exp => {
                        addExperience(exp);
                    });
                } else {
                    addExperience();
                }
                
                // Load education
                if (data.education && data.education.length > 0) {
                    data.education.forEach(edu => {
                        addEducation(edu);
                    });
                } else {
                    addEducation();
                }
                
                // Load projects
                if (data.projects) {
                    data.projects.forEach(proj => {
                        addProject(proj);
                    });
                }
                
                // Load certifications
                if (data.certifications) {
                    data.certifications.forEach(cert => {
                        addCertification(cert);
                    });
                }
                
                updatePreview();
            }
        }

        // Skills management
        document.getElementById('skillInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const skill = this.value.trim();
                if (skill && !skills.includes(skill)) {
                    skills.push(skill);
                    updateSkillsDisplay();
                    this.value = '';
                    updatePreview();
                }
            }
        });

        function updateSkillsDisplay() {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = skills.map((skill, index) => `
                <div class="tag">
                    <span>${skill}</span>
                    <span class="tag-remove" onclick="removeSkill(${index})">&times;</span>
                </div>
            `).join('');
        }

        function removeSkill(index) {
            skills.splice(index, 1);
            updateSkillsDisplay();
            updatePreview();
        }

        // Experience management
        function addExperience(data = null) {
            const index = experiences.length;
            const exp = data || { company: '', position: '', startDate: '', endDate: '', description: '' };
            experiences.push(exp);
            
            const container = document.getElementById('experienceContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Experience ${index + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExperience(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Company</label>
                        <input type="text" class="form-control" value="${exp.company}" onchange="updateExperience(${index}, 'company', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" value="${exp.position}" onchange="updateExperience(${index}, 'position', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Start Date</label>
                        <input type="month" class="form-control" value="${exp.startDate}" onchange="updateExperience(${index}, 'startDate', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Date</label>
                        <input type="month" class="form-control" value="${exp.endDate}" onchange="updateExperience(${index}, 'endDate', this.value)">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="current${index}" ${exp.current ? 'checked' : ''} onchange="updateExperience(${index}, 'current', this.checked)">
                            <label class="form-check-label" for="current${index}">Currently working here</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="3" onchange="updateExperience(${index}, 'description', this.value)">${exp.description}</textarea>
                        <small class="text-muted">Describe your responsibilities and achievements</small>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function updateExperience(index, field, value) {
            experiences[index][field] = value;
            updatePreview();
        }

        function removeExperience(index) {
            experiences.splice(index, 1);
            const container = document.getElementById('experienceContainer');
            container.innerHTML = '';
            experiences.forEach((exp, i) => addExperience(exp));
            updatePreview();
        }

        // Education management
        function addEducation(data = null) {
            const index = educations.length;
            const edu = data || { school: '', degree: '', field: '', graduationDate: '' };
            educations.push(edu);
            
            const container = document.getElementById('educationContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Education ${index + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEducation(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">School/University</label>
                        <input type="text" class="form-control" value="${edu.school}" onchange="updateEducation(${index}, 'school', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Degree</label>
                        <input type="text" class="form-control" value="${edu.degree}" placeholder="e.g., Bachelor's" onchange="updateEducation(${index}, 'degree', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Field of Study</label>
                        <input type="text" class="form-control" value="${edu.field}" placeholder="e.g., Computer Science" onchange="updateEducation(${index}, 'field', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Graduation Date</label>
                        <input type="month" class="form-control" value="${edu.graduationDate}" onchange="updateEducation(${index}, 'graduationDate', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function updateEducation(index, field, value) {
            educations[index][field] = value;
            updatePreview();
        }

        function removeEducation(index) {
            educations.splice(index, 1);
            const container = document.getElementById('educationContainer');
            container.innerHTML = '';
            educations.forEach((edu, i) => addEducation(edu));
            updatePreview();
        }

        // Projects management
        function addProject(data = null) {
            const index = projects.length;
            const proj = data || { name: '', description: '', url: '' };
            projects.push(proj);
            
            const container = document.getElementById('projectsContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Project ${index + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProject(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-control" value="${proj.name}" onchange="updateProject(${index}, 'name', this.value)">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="2" onchange="updateProject(${index}, 'description', this.value)">${proj.description}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">URL (Optional)</label>
                        <input type="url" class="form-control" value="${proj.url}" placeholder="https://" onchange="updateProject(${index}, 'url', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function updateProject(index, field, value) {
            projects[index][field] = value;
            updatePreview();
        }

        function removeProject(index) {
            projects.splice(index, 1);
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '';
            projects.forEach((proj, i) => addProject(proj));
            updatePreview();
        }

        // Certifications management
        function addCertification(data = null) {
            const index = certifications.length;
            const cert = data || { name: '', issuer: '', date: '' };
            certifications.push(cert);
            
            const container = document.getElementById('certificationsContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Certification ${index + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCertification(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Certification Name</label>
                        <input type="text" class="form-control" value="${cert.name}" onchange="updateCertification(${index}, 'name', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Issuing Organization</label>
                        <input type="text" class="form-control" value="${cert.issuer}" onchange="updateCertification(${index}, 'issuer', this.value)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Issue Date</label>
                        <input type="month" class="form-control" value="${cert.date}" onchange="updateCertification(${index}, 'date', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function updateCertification(index, field, value) {
            certifications[index][field] = value;
            updatePreview();
        }

        function removeCertification(index) {
            certifications.splice(index, 1);
            const container = document.getElementById('certificationsContainer');
            container.innerHTML = '';
            certifications.forEach((cert, i) => addCertification(cert));
            updatePreview();
        }

        // Update preview
        function updatePreview() {
            const preview = document.getElementById('resumePreview');
            const data = getFormData();
            
            preview.innerHTML = `
                <div style="font-family: 'Inter', sans-serif; line-height: 1.6;">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold mb-2">${data.fullName || 'Your Name'}</h2>
                        <div class="text-muted">
                            ${data.email || 'email@example.com'} ${data.phone ? '• ' + data.phone : ''} ${data.location ? '• ' + data.location : ''}
                        </div>
                        ${data.linkedin ? `<div class="text-primary small">${data.linkedin}</div>` : ''}
                    </div>
                    
                    ${data.summary ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-2 pb-2 border-bottom">Professional Summary</h5>
                            <p class="mb-0">${data.summary}</p>
                        </div>
                    ` : ''}
                    
                    ${experiences.filter(e => e.company).length > 0 ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 pb-2 border-bottom">Work Experience</h5>
                            ${experiences.filter(e => e.company).map(exp => `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="fw-semibold mb-1">${exp.position || 'Position'}</h6>
                                        <small class="text-muted">${exp.startDate ? formatMonthYear(exp.startDate) : ''} - ${exp.current ? 'Present' : (exp.endDate ? formatMonthYear(exp.endDate) : '')}</small>
                                    </div>
                                    <div class="text-muted mb-2">${exp.company}</div>
                                    ${exp.description ? `<p class="mb-0 small">${exp.description}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${educations.filter(e => e.school).length > 0 ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 pb-2 border-bottom">Education</h5>
                            ${educations.filter(e => e.school).map(edu => `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="fw-semibold mb-1">${edu.degree || 'Degree'} ${edu.field ? 'in ' + edu.field : ''}</h6>
                                        <small class="text-muted">${edu.graduationDate ? formatMonthYear(edu.graduationDate) : ''}</small>
                                    </div>
                                    <div class="text-muted">${edu.school}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${skills.length > 0 ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 pb-2 border-bottom">Skills</h5>
                            <div class="d-flex flex-wrap gap-2">
                                ${skills.map(skill => `
                                    <span class="badge bg-primary">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${projects.filter(p => p.name).length > 0 ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 pb-2 border-bottom">Projects</h5>
                            ${projects.filter(p => p.name).map(proj => `
                                <div class="mb-3">
                                    <h6 class="fw-semibold mb-1">${proj.name}</h6>
                                    ${proj.description ? `<p class="mb-1 small">${proj.description}</p>` : ''}
                                    ${proj.url ? `<a href="${proj.url}" class="text-primary small">${proj.url}</a>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${certifications.filter(c => c.name).length > 0 ? `
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 pb-2 border-bottom">Certifications</h5>
                            ${certifications.filter(c => c.name).map(cert => `
                                <div class="mb-2">
                                    <h6 class="fw-semibold mb-1">${cert.name}</h6>
                                    <div class="text-muted small">${cert.issuer} ${cert.date ? '• ' + formatMonthYear(cert.date) : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function formatMonthYear(monthString) {
            if (!monthString) return '';
            const [year, month] = monthString.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        }

        function getFormData() {
            return {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                linkedin: document.getElementById('linkedin').value,
                summary: document.getElementById('summary').value,
                experience: experiences,
                education: educations,
                skills: skills,
                projects: projects,
                certifications: certifications
            };
        }

        // Auto-update preview on any input change
        document.getElementById('resumeForm').addEventListener('input', updatePreview);
        document.getElementById('resumeForm').addEventListener('change', updatePreview);

        // Save resume
        document.getElementById('saveBtn').addEventListener('click', function() {
            const user = getCurrentUser();
            const resumeName = document.getElementById('resumeName').value.trim();
            const template = document.getElementById('template').value;
            
            if (!resumeName) {
                alert('Please enter a resume name');
                return;
            }
            
            const data = getFormData();
            
            if (!data.fullName || !data.email) {
                alert('Please fill in at least your name and email');
                return;
            }
            
            // Check plan limit for new resumes
            if (!currentResumeId && user.plan === 'free') {
                const resumes = getResumes(user.email);
                if (resumes.length >= 1) {
                    alert('Free plan allows only 1 resume. Upgrade to Premium for unlimited resumes!');
                    window.location.href = 'pricing.html';
                    return;
                }
            }
            
            const resume = {
                id: currentResumeId || generateResumeId(),
                userId: user.email,
                name: resumeName,
                template: template,
                progress: calculateProgress(data),
                atsScore: calculateATSScore(data),
                data: data
            };
            
            saveResume(resume);
            alert('Resume saved successfully!');
            
            if (!currentResumeId) {
                currentResumeId = resume.id;
                window.history.replaceState({}, '', `resume-builder.html?id=${resume.id}`);
            }
        });

        function previewResume() {
            if (!currentResumeId) {
                alert('Please save your resume first');
                return;
            }
            window.location.href = `resume-preview.html?id=${currentResumeId}`;
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 1.5);
            document.getElementById('resumePreview').style.transform = `scale(${zoomLevel})`;
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            document.getElementById('resumePreview').style.transform = `scale(${zoomLevel})`;
        }
    </script>
</body>
</html>
