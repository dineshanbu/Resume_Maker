<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - ResumePro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5 class="fw-bold mb-0">
                    <i class="bi bi-file-earmark-text text-primary"></i>
                    <span class="text-primary">Resume</span><span class="text-white">Pro</span>
                </h5>
            </div>
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="resumes.html" class="menu-item">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>My Resumes</span>
                </a>
                <a href="resume-builder.html" class="menu-item">
                    <i class="bi bi-plus-circle"></i>
                    <span>Create Resume</span>
                </a>
                <a href="templates.html" class="menu-item">
                    <i class="bi bi-collection"></i>
                    <span>Templates</span>
                </a>
                <a href="jobs.html" class="menu-item">
                    <i class="bi bi-briefcase"></i>
                    <span>Job Matches</span>
                </a>
                <a href="pricing.html" class="menu-item">
                    <i class="bi bi-star"></i>
                    <span>Upgrade</span>
                </a>
                <a href="profile.html" class="menu-item active">
                    <i class="bi bi-person"></i>
                    <span>Profile</span>
                </a>
                <a href="#" class="menu-item" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <h4 class="mb-0 fw-bold">Profile Settings</h4>
                    <small class="text-muted">Manage your account information</small>
                </div>
                <button class="btn btn-sm btn-outline-primary d-lg-none" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
            </header>

            <!-- Content -->
            <div class="dashboard-content">
                <div class="row g-4">
                    <!-- Profile Info -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-4">Personal Information</h5>
                                <form id="profileForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" disabled>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-save me-2"></i>Save Changes
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Change Password -->
                        <div class="card border-0 shadow-sm mt-4">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-4">Change Password</h5>
                                <form id="passwordForm">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="currentPassword" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-shield-check me-2"></i>Update Password
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Plan & Stats Sidebar -->
                    <div class="col-lg-4">
                        <!-- Current Plan -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-3">Current Plan</h5>
                                <div class="text-center py-3" id="planDisplay">
                                    <!-- Plan info will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Resume Stats -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <h5 class="card-title fw-bold mb-3">Your Stats</h5>
                                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                                    <span class="text-muted">Total Resumes</span>
                                    <span class="fw-bold" id="totalResumes">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                                    <span class="text-muted">Avg. ATS Score</span>
                                    <span class="fw-bold" id="avgAtsScore">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center py-3">
                                    <span class="text-muted">Member Since</span>
                                    <span class="fw-bold" id="memberSince">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="card border-danger mt-4">
                            <div class="card-body p-4">
                                <h6 class="card-title text-danger fw-bold mb-3">Danger Zone</h6>
                                <p class="small text-muted">Once you delete your account, there is no going back. Please be certain.</p>
                                <button class="btn btn-outline-danger w-100" onclick="deleteAccount()">
                                    <i class="bi bi-trash me-2"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/auth.js"></script>
    <script src="./assets/js/resume.js"></script>
    <script>
        if (!requireAuth()) throw new Error('Unauthorized');

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Load profile data
        const user = getCurrentUser();
        document.getElementById('name').value = user.name;
        document.getElementById('email').value = user.email;

        // Load plan display
        const planDisplay = document.getElementById('planDisplay');
        if (user.plan === 'premium') {
            planDisplay.innerHTML = `
                <div class="display-6 fw-bold text-warning mb-2">
                    <i class="bi bi-star-fill"></i> Premium
                </div>
                <p class="text-muted small">Unlimited access to all features</p>
            `;
        } else {
            planDisplay.innerHTML = `
                <div class="display-6 fw-bold mb-2">Free</div>
                <p class="text-muted small mb-3">Limited features</p>
                <a href="pricing.html" class="btn btn-primary w-100">
                    <i class="bi bi-star me-2"></i>Upgrade to Premium
                </a>
            `;
        }

        // Load stats
        const resumes = getResumes(user.email);
        document.getElementById('totalResumes').textContent = resumes.length;
        
        if (resumes.length > 0) {
            const avgScore = Math.round(
                resumes.reduce((sum, r) => sum + (r.atsScore || 0), 0) / resumes.length
            );
            document.getElementById('avgAtsScore').textContent = avgScore;
        }

        if (user.createdAt) {
            const date = new Date(user.createdAt);
            document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        // Profile form handler
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            
            user.name = name;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Update in users list
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === user.email);
            if (userIndex >= 0) {
                users[userIndex].name = name;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            alert('Profile updated successfully!');
        });

        // Password form handler
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== user.password) {
                alert('Current password is incorrect');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            user.password = newPassword;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Update in users list
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === user.email);
            if (userIndex >= 0) {
                users[userIndex].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            alert('Password updated successfully!');
            document.getElementById('passwordForm').reset();
        });

        function deleteAccount() {
            if (confirm('Are you absolutely sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('Last chance! All your resumes will be permanently deleted. Continue?')) {
                    // Remove user
                    let users = JSON.parse(localStorage.getItem('users') || '[]');
                    users = users.filter(u => u.email !== user.email);
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Remove user's resumes
                    let resumes = JSON.parse(localStorage.getItem('resumes') || '[]');
                    resumes = resumes.filter(r => r.userId !== user.email);
                    localStorage.setItem('resumes', JSON.stringify(resumes));
                    
                    // Logout
                    localStorage.removeItem('currentUser');
                    alert('Account deleted successfully. Sorry to see you go!');
                    window.location.href = 'index.html';
                }
            }
        }
    </script>
</body>
</html>